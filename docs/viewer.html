<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gitshelves Viewer</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #controls { position: fixed; top: 0; left: 0; background: #fff8; padding: 8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js"></script>
</head>
<body>
<div id="controls">
  <input type="file" id="files" multiple />
  <div id="status">Select STL files to preview.</div>
</div>
<script>
const palette = [0x1f77b4, 0xff7f0e, 0x2ca02c, 0xd62728];
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
 document.body.appendChild(renderer.domElement);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f0f0);
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
camera.position.set(120, 120, 120);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
const loader = new THREE.STLLoader();
const status = document.getElementById('status');
function updateStatus(message) {
  if (status) status.textContent = message;
}
function clearMeshes() {
  scene.children.filter(o => o.isMesh).forEach(o => scene.remove(o));
}
function loadFiles(list) {
  clearMeshes();
  if (!list.length) {
    updateStatus('Select STL files to preview.');
    return;
  }
  const stls = [];
  for (const file of list) {
    let colorIndex = 0;
    const colorMatch = file.name.match(/color(\d+)/i);
    const levelMatch = file.name.match(/level(\d+)/i);
    if (colorMatch) {
      colorIndex = parseInt(colorMatch[1], 10);
    } else if (levelMatch) {
      colorIndex = parseInt(levelMatch[1], 10);
    }
    if (/baseplate/i.test(file.name)) colorIndex = 0;
    stls.push({ file, colorIndex });
  }
  const maxColorIndex = stls.reduce((max, entry) => Math.max(max, entry.colorIndex), 0);
  const detected = Math.max(maxColorIndex, 1);
  updateStatus(`Detected ${detected} color group${detected === 1 ? '' : 's'}.`);
  stls.forEach(({ file, colorIndex }) => {
    const reader = new FileReader();
    reader.onload = e => {
      const geo = loader.parse(e.target.result);
      const paletteIndex = colorIndex > 0
        ? ((colorIndex - 1) % (palette.length - 1)) + 1
        : 0;
      const mat = new THREE.MeshPhongMaterial({ color: palette[paletteIndex] });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.name = file.name;
      scene.add(mesh);
    };
    reader.readAsArrayBuffer(file);
  });
}
const input = document.getElementById('files');
input.addEventListener('change', e => loadFiles(e.target.files));
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(1, 1, 1).normalize();
scene.add(light);
const ambient = new THREE.AmbientLight(0xffffff, 0.2);
scene.add(ambient);
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
